<!DOCTYPE html>
<html lang="en">
    <head>
        <%- include('../partials/head') %>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Weekly Medication View</title>
        <link rel="stylesheet" href="/css/all-medications.css" />
        <link rel="stylesheet" href="/css/weekly-medications.css" />
        <link rel="stylesheet" href="/css/medication-nav.css" />
        <!-- Load Bootstrap and FontAwesome -->
        <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" rel="stylesheet" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
        <!-- Load utilities first, before any other scripts -->
        <script>
            // Inline utility functions to ensure they're available immediately
            window.showLoading =
                window.showLoading ||
                function (message = "Loading...") {
                    console.log("Loading:", message);
                    createUtilityAlert(message, "info");
                };

            window.showError =
                window.showError ||
                function (message) {
                    console.error("Error:", message);
                    createUtilityAlert(message, "danger");
                };

            window.showAlert =
                window.showAlert ||
                function (message, type = "success") {
                    console.log(`${type.toUpperCase()}: ${message}`);
                    createUtilityAlert(message, type);
                };

            function createUtilityAlert(message, type) {
                let alertContainer = document.getElementById("alert-container");
                if (!alertContainer) {
                    alertContainer = document.createElement("div");
                    alertContainer.id = "alert-container";
                    alertContainer.style.cssText = "position: fixed; top: 20px; right: 20px; z-index: 10000; max-width: 400px;";
                    document.body.appendChild(alertContainer);
                }

                const alert = document.createElement("div");
                alert.className = `alert alert-${type}`;
                alert.style.cssText = "margin-bottom: 10px; padding: 10px; border-radius: 4px; position: relative; border: 1px solid transparent;";

                const styles = {
                    success: { bg: "#d4edda", border: "#c3e6cb", color: "#155724" },
                    warning: { bg: "#fff3cd", border: "#ffeaa7", color: "#856404" },
                    danger: { bg: "#f8d7da", border: "#f5c6cb", color: "#721c24" },
                    info: { bg: "#d1ecf1", border: "#bee5eb", color: "#0c5460" },
                };

                const style = styles[type] || styles.info;
                alert.style.backgroundColor = style.bg;
                alert.style.borderColor = style.border;
                alert.style.color = style.color;

                alert.innerHTML = `
        <button type="button" class="close" onclick="this.parentElement.remove()" style="position: absolute; top: 5px; right: 10px; background: none; border: none; font-size: 18px; cursor: pointer; color: ${
            style.color
        };">
          <span>&times;</span>
        </button>
        <div style="margin-right: 30px;">
          ${type === "info" ? '<i class="fa fa-info-circle"></i>' : ""}
          ${type === "success" ? '<i class="fa fa-check-circle"></i>' : ""}
          ${type === "warning" ? '<i class="fa fa-exclamation-triangle"></i>' : ""}
          ${type === "danger" ? '<i class="fa fa-times-circle"></i>' : ""}
          ${message}
        </div>
      `;

                alertContainer.appendChild(alert);

                setTimeout(() => {
                    if (alert.parentElement) {
                        alert.remove();
                    }
                }, 5000);
            }

            // Safe DateUtils declaration
            if (!window.DateUtils) {
                window.DateUtils = {
                    formatDate: function (dateString) {
                        if (!dateString) return "Not specified";
                        try {
                            const date = new Date(dateString);
                            if (isNaN(date.getTime())) return "Invalid date";
                            const options = { year: "numeric", month: "short", day: "numeric" };
                            return date.toLocaleDateString("en-US", options);
                        } catch (error) {
                            return "Invalid date";
                        }
                    },
                    formatTime: function (timeString) {
                        if (!timeString) return "Not specified";
                        try {
                            const timeParts = timeString.split(":");
                            if (timeParts.length >= 2) {
                                const hours = parseInt(timeParts[0]);
                                const minutes = timeParts[1];
                                const ampm = hours >= 12 ? "PM" : "AM";
                                const displayHours = hours % 12 || 12;
                                return `${displayHours}:${minutes} ${ampm}`;
                            }
                            return timeString;
                        } catch (error) {
                            return timeString;
                        }
                    },
                    getRelativeTime: function (date, time) {
                        try {
                            const now = new Date();
                            let medDateTime;
                            if (time) {
                                medDateTime = new Date(`${date}T${time}`);
                            } else {
                                medDateTime = new Date(date);
                            }
                            if (isNaN(medDateTime.getTime())) return "Invalid date";
                            const diffMinutes = Math.round((medDateTime - now) / (1000 * 60));
                            if (diffMinutes <= 0) {
                                return "Now";
                            } else if (diffMinutes < 60) {
                                return `in ${diffMinutes} minute${diffMinutes !== 1 ? "s" : ""}`;
                            } else if (diffMinutes < 1440) {
                                const hours = Math.floor(diffMinutes / 60);
                                return `in ${hours} hour${hours !== 1 ? "s" : ""}`;
                            } else {
                                const days = Math.floor(diffMinutes / 1440);
                                return `in ${days} day${days !== 1 ? "s" : ""}`;
                            }
                        } catch (error) {
                            return "Unknown";
                        }
                    },
                };
            }
        </script>
    </head>
    <body>
        <%- include('../partials/navbar') %>
        <!-- Remove the header section and replace with breadcrumb + tabs -->

        <main class="container">
            <nav aria-label="breadcrumb" style="margin-bottom: 20px">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/index.html">Home</a></li>
                    <li class="breadcrumb-item"><a href="/medications">Medications</a></li>
                    <li class="breadcrumb-item active">Weekly View</li>
                </ol>
            </nav>

            <div class="medication-nav-tabs" style="margin-bottom: 20px">
                <ul class="nav nav-tabs">
                    <li class="nav-item">
                        <a class="nav-link" href="/medications">All Medications</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/medications/daily">Daily View</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/medications/weekly">Weekly View</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/medications/create">Add Medication</a>
                    </li>
                </ul>
            </div>

            <div id="alert-container"></div>

            <!-- Add testing notice -->
            <div class="alert alert-info" style="margin-bottom: 20px">
                <strong>Testing Mode:</strong> Authentication disabled. Using test user ID: 8
            </div>

            <div class="weekly-header">
                <h1>Weekly Medications</h1>
                <div class="week-navigation">
                    <button id="prev-week" class="btn btn-outline">Previous</button>
                    <div class="week-range">
                        <span id="current-week"></span>
                        <div class="week-date-readable" id="current-week-readable" style="font-size: 0.9em; color: #666; margin-top: 5px"></div>
                    </div>
                    <button id="next-week" class="btn btn-outline">Next</button>
                </div>
            </div>

            <!-- Add the missing elements that JavaScript expects -->
            <div id="loading-message" style="display: none"></div>
            <div id="no-medications-message" style="display: none" class="alert alert-info">
                <i class="fa fa-info-circle"></i> No medications scheduled for this week.
            </div>
            <div id="error-message" style="display: none" class="alert alert-danger"></div>

            <!-- Change this ID from weekly-container to weekly-calendar -->
            <div id="weekly-calendar">
                <!-- Calendar content will be populated by JavaScript -->
            </div>

            <!-- Weekly Summary -->
            <div class="card" style="margin-top: 20px">
                <div class="card-header">
                    <h3>Weekly Summary</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-number" id="weekly-total">0</div>
                                <div class="stat-label">Total</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-number" id="weekly-taken">0</div>
                                <div class="stat-label">Taken</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-number" id="weekly-remaining">0</div>
                                <div class="stat-label">Remaining</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="progress" style="height: 20px">
                                <div id="weekly-progress" class="progress-bar" role="progressbar" style="width: 0%">0%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Load jQuery and Bootstrap JS -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

        <!-- Load notification system after utilities are ready -->
        <script src="/js/notification-system.js"></script>

        <!-- Load page-specific script last -->
        <script src="/js/weekly_medication_script.js"></script>
    </body>
    <%- include('../partials/footer') %>
</html>
